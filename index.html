<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹œè®¿ç”¨æ—¶æŸ¥è¯¢ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .section-title {
            font-size: 20px;
            color: #374151;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .upload-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }

        .upload-card h3 {
            font-size: 16px;
            color: #374151;
            margin-bottom: 12px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .upload-area:hover {
            background: #f3f4f6;
            border-color: #5568d3;
        }

        .upload-area.dragover {
            background: #eef2ff;
            border-color: #4f46e5;
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #667eea;
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 8px;
        }

        .upload-hint {
            color: #6b7280;
            font-size: 13px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f3f4f6;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }

        th {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            position: sticky;
            top: 0;
            background: #f3f4f6;
            z-index: 1;
        }

        td {
            color: #6b7280;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            background: #d1fae5;
            color: #065f46;
        }

        .instructions {
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .instructions h4 {
            color: #1e40af;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .instructions ul {
            margin-left: 20px;
            color: #1e3a8a;
            line-height: 1.8;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        .filter-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
            margin-bottom: 20px;
        }

        .filter-item label {
            display: block;
            font-size: 14px;
            margin-bottom: 5px;
            color: #4b5563;
            font-weight: 500;
        }

        .filter-item input,
        .filter-item select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-item input:focus,
        .filter-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            color: #6b7280;
            font-size: 14px;
        }

        .pagination-info strong {
            color: #374151;
            font-weight: 600;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            transition: all 0.3s;
        }

        .page-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
        }

        .page-number {
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            transition: all 0.3s;
        }

        .page-number:hover {
            background: #f3f4f6;
            border-color: #667eea;
        }

        .page-number.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-ellipsis {
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 14px;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-size-selector label {
            color: #6b7280;
            font-size: 14px;
        }

        .page-size-selector select {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            background: white;
            color: #374151;
        }

        .page-size-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* ============ å¤§åŒºç»Ÿè®¡æ ·å¼ ============ */
        .region-summary {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .region-summary-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .region-summary-desc {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .region-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .region-card {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8ecff 100%);
            border-radius: 10px;
            padding: 18px;
            border: 2px solid #c7d2fe;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        .region-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.25);
            border-color: #818cf8;
        }

        .region-card.active {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.35);
            border-color: #4f46e5;
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        }

        .region-card-name {
            font-size: 15px;
            font-weight: 600;
            color: #4338ca;
            margin-bottom: 8px;
            word-break: break-all;
        }

        .region-card-count {
            font-size: 28px;
            font-weight: 700;
            color: #ef4444;
            line-height: 1;
        }

        .region-card-unit {
            font-size: 13px;
            color: #6b7280;
            margin-top: 4px;
        }

        .region-card-hint {
            font-size: 12px;
            color: #818cf8;
            margin-top: 8px;
            font-weight: 500;
        }

        .region-card.active .region-card-hint {
            color: #4338ca;
        }

        .region-card.unknown {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #fbbf24;
        }

        .region-card.unknown:hover {
            border-color: #f59e0b;
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.25);
        }

        .region-card.unknown.active {
            border-color: #d97706;
            box-shadow: 0 6px 20px rgba(217, 119, 6, 0.35);
            background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
        }

        .region-card.unknown .region-card-name {
            color: #92400e;
        }

        .region-card.unknown .region-card-hint {
            color: #b45309;
        }

        /* ============ ç‰‡åŒºå±•å¼€é¢æ¿æ ·å¼ ============ */
        .area-detail-panel {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.4s ease, opacity 0.3s ease, margin 0.3s ease, padding 0.3s ease;
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
            border-radius: 12px;
            border: 2px solid #c4b5fd;
            margin-bottom: 0;
            padding: 0 20px;
        }

        .area-detail-panel.open {
            max-height: 2000px;
            opacity: 1;
            margin-bottom: 15px;
            padding: 20px;
        }

        .area-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .area-detail-title {
            font-size: 16px;
            font-weight: 600;
            color: #5b21b6;
        }

        .area-detail-title span {
            color: #7c3aed;
            font-weight: 700;
        }

        .area-detail-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #c4b5fd;
            background: white;
            color: #7c3aed;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            line-height: 1;
        }

        .area-detail-close:hover {
            background: #7c3aed;
            color: white;
            border-color: #7c3aed;
        }

        .area-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .area-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #ddd6fe;
            transition: all 0.2s;
        }

        .area-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.15);
            border-color: #a78bfa;
        }

        .area-card-name {
            font-size: 14px;
            font-weight: 600;
            color: #6d28d9;
            margin-bottom: 6px;
            word-break: break-all;
        }

        .area-card-count {
            font-size: 22px;
            font-weight: 700;
            color: #ef4444;
            line-height: 1;
        }

        .area-card-unit {
            font-size: 12px;
            color: #6b7280;
            margin-top: 3px;
        }

        .area-card-percent {
            font-size: 12px;
            color: #7c3aed;
            font-weight: 600;
            margin-top: 4px;
        }

        .area-detail-table-wrap {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #ddd6fe;
            background: white;
        }

        .area-detail-table {
            width: 100%;
            border-collapse: collapse;
        }

        .area-detail-table th,
        .area-detail-table td {
            padding: 10px 14px;
            text-align: left;
            border-bottom: 1px solid #ede9fe;
            font-size: 13px;
        }

        .area-detail-table th {
            background: #f5f3ff;
            font-weight: 600;
            color: #5b21b6;
        }

        .area-detail-table td {
            color: #6b7280;
        }

        .area-detail-table .area-count-cell {
            font-weight: 700;
            color: #ef4444;
            font-size: 15px;
        }

        .area-detail-table .area-percent-cell {
            color: #7c3aed;
            font-weight: 600;
        }

        .area-detail-table tbody tr:hover {
            background: #faf5ff;
        }

        .area-detail-total {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 10px 14px;
            background: #ede9fe;
            border-radius: 8px;
            font-size: 14px;
        }

        .area-detail-total strong {
            color: #5b21b6;
        }

        .area-detail-total span {
            color: #ef4444;
            font-weight: 700;
            font-size: 18px;
        }

        .region-summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .region-summary-table th,
        .region-summary-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .region-summary-table th {
            background: #f3f4f6;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .region-summary-table td {
            color: #6b7280;
            font-size: 14px;
        }

        .region-summary-table .count-cell {
            font-weight: 700;
            color: #ef4444;
            font-size: 16px;
        }

        .region-summary-table .percent-cell {
            color: #667eea;
            font-weight: 600;
        }

        .region-summary-table tbody tr:hover {
            background: #f9fafb;
        }

        .region-total-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 12px 15px;
            background: #fef2f2;
            border-radius: 8px;
            border: 1px solid #fca5a5;
        }

        .region-total-bar strong {
            color: #991b1b;
            font-size: 15px;
        }

        .region-total-bar span {
            color: #ef4444;
            font-size: 20px;
            font-weight: 700;
        }

        .cleanup-section {
            background: #fef2f2;
            border: 2px solid #fca5a5;
        }

        .cleanup-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .cleanup-warning h4 {
            color: #92400e;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cleanup-warning p {
            color: #78350f;
            line-height: 1.6;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ‹œè®¿ç”¨æ—¶æŸ¥è¯¢ç³»ç»Ÿ</h1>
        </div>

        <div class="content">
            <div class="section">
                <div class="section-title">
                    <span>Step 1</span> ä¸Šä¼ æ•°æ®è¡¨
                </div>

                <div class="upload-row">
                    <div class="upload-card">
                        <h3>æ‹œè®¿æ˜ç»†è®°å½•è¡¨</h3>
                        <div class="instructions">
                            <h4>æ–‡ä»¶æ ¼å¼è¦æ±‚ï¼š</h4>
                            <ul>
                                <li>æ”¯æŒ Excel (.xlsx, .xls) æ–‡ä»¶</li>
                                <li>å¿…é¡»åŒ…å«åˆ—ï¼šæ‹œè®¿è®°å½•ç¼–å·ã€æ‹œè®¿å¼€å§‹æ—¶é—´ã€æ‹œè®¿ç»“æŸæ—¶é—´ã€æ‹œè®¿äººã€å®¢æˆ·åç§°ã€å®¢æˆ·ç¼–ç ã€æ‹œè®¿ç”¨æ—¶</li>
                            </ul>
                        </div>
                        <div class="upload-area" id="visitUploadArea" onclick="document.getElementById('fileInput').click()">
                            <div class="upload-icon">ğŸ“‹</div>
                            <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ‹œè®¿æ˜ç»†è®°å½•è¡¨</p>
                            <p class="upload-hint">æ”¯æŒ .xlsx, .xls æ ¼å¼</p>
                            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event)">
                        </div>
                        <div id="uploadStatus"></div>
                    </div>

                    <div class="upload-card">
                        <h3>ç»ˆç«¯é—¨åº—æ¸…å•è¡¨</h3>
                        <div class="instructions">
                            <h4>æ–‡ä»¶æ ¼å¼è¦æ±‚ï¼š</h4>
                            <ul>
                                <li>æ”¯æŒ Excel (.xlsx, .xls) æ–‡ä»¶</li>
                                <li>å¿…é¡»åŒ…å«åˆ—ï¼šå®¢æˆ·ç¼–ç ã€æ‰€å±ç‰‡åŒºã€æ‰€å±å¤§åŒº</li>
                                <li>ç”¨äºè¡¥å……æ‹œè®¿æ˜ç»†è®°å½•è¡¨ä¸­å®¢æˆ·çš„å½’å±ä¿¡æ¯</li>
                            </ul>
                        </div>
                        <div class="upload-area" id="terminalUploadArea" onclick="document.getElementById('terminalFileInput').click()">
                            <div class="upload-icon">ğŸ¢</div>
                            <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ç»ˆç«¯é—¨åº—æ¸…å•è¡¨</p>
                            <p class="upload-hint">æ”¯æŒ .xlsx, .xls æ ¼å¼</p>
                            <input type="file" id="terminalFileInput" accept=".xlsx,.xls" onchange="handleTerminalFileSelect(event)">
                        </div>
                        <div id="terminalUploadStatus"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">
                    <span>Step 2</span> æŸ¥è¯¢ç»“æœ
                </div>

                <div class="filter-form">
                    <div class="filter-item">
                        <label for="maxMinutes">æœ€å¤§æ‹œè®¿ç”¨æ—¶ï¼ˆåˆ†é’Ÿï¼‰</label>
                        <input type="number" id="maxMinutes" value="5" min="0" step="1">
                    </div>
                    <div class="filter-item">
                        <label for="visitor">æ‹œè®¿äºº</label>
                        <input type="text" id="visitor">
                    </div>
                    <div class="filter-item">
                        <label for="customerName">å®¢æˆ·åç§°</label>
                        <input type="text" id="customerName">
                    </div>
                    <div class="filter-item">
                        <label for="customerCode">å®¢æˆ·ç¼–ç </label>
                        <input type="text" id="customerCode">
                    </div>
                    <div class="filter-item">
                        <label for="area">æ‰€å±ç‰‡åŒº</label>
                        <input type="text" id="area">
                    </div>
                    <div class="filter-item">
                        <label for="region">æ‰€å±å¤§åŒº</label>
                        <input type="text" id="region">
                    </div>
                    <div class="filter-item">
                        <label for="startDate">å¼€å§‹æ—¥æœŸ >=</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="filter-item">
                        <label for="endDate">ç»“æŸæ—¥æœŸ <=</label>
                        <input type="date" id="endDate">
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="queryRecords()">
                        æ‰§è¡ŒæŸ¥è¯¢
                    </button>
                    <button class="btn btn-success" onclick="exportToExcel()" id="exportBtn" style="display: none;">
                        å¯¼å‡ºä¸º Excel
                    </button>
                </div>

                <div id="queryStatus"></div>

                <div id="regionSummaryContainer"></div>

                <div id="resultContainer"></div>

                <div id="paginationContainer" style="display: none;"></div>
            </div>

            <div class="section cleanup-section">
                <div class="section-title">
                    <span>Step 3</span> æ¸…ç†æ•°æ®åº“
                </div>

                <div class="cleanup-warning">
                    <h4>âš ï¸ è­¦å‘Š</h4>
                    <p><strong>æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤å½“å‰æ•°æ®åº“åŠå…¶ä¸­çš„æ‰€æœ‰è¡¨å’Œæ•°æ®ï¼</strong></p>
                    <p>åˆ é™¤åæ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼</p>
                </div>

                <div class="btn-group">
                    <button class="btn btn-danger" onclick="cleanupDatabase()">
                        ğŸ—‘ï¸ åˆ é™¤æ•°æ®åº“
                    </button>
                </div>

                <div id="cleanupStatus"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        const API_URL = 'http://localhost:8011'; // æ³¨æ„ï¼šç«¯å£å·æ˜¯ 8011
        let currentData = [];
        let currentPage = 1;
        let pageSize = 1000;
        let totalPages = 0;

        // å¤§åŒº -> ç‰‡åŒºç»Ÿè®¡çš„ç¼“å­˜æ•°æ®
        let regionAreaMap = {};
        // å½“å‰å±•å¼€çš„å¤§åŒºåç§°ï¼ˆnull è¡¨ç¤ºå…¨éƒ¨æ”¶èµ·ï¼‰
        let expandedRegion = null;

        // ============ Visit æ–‡ä»¶ä¸Šä¼  ============

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨è¯»å–æ–‡ä»¶...</div>';

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) {
                        statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶ä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹</div>';
                        return;
                    }

                    statusDiv.innerHTML = '<div class="status-message status-success">æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå…± ' + jsonData.length + ' æ¡è®°å½•ï¼Œæ­£åœ¨ä¸Šä¼ ...</div>';
                    uploadVisitInBatches(jsonData);
                } catch (error) {
                    statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶è§£æå¤±è´¥: ' + error.message + '</div>';
                }
            };

            reader.onerror = function() {
                statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶è¯»å–å¤±è´¥</div>';
            };

            reader.readAsArrayBuffer(file);
        }

        async function uploadVisitInBatches(records) {
            const statusDiv = document.getElementById('uploadStatus');
            const BATCH_SIZE = 5000;
            const totalBatches = Math.ceil(records.length / BATCH_SIZE);
            let totalInserted = 0;

            try {
                for (let i = 0; i < totalBatches; i++) {
                    const batch = records.slice(i * BATCH_SIZE, (i + 1) * BATCH_SIZE);
                    statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨ä¸Šä¼ ç¬¬ ' + (i + 1) + '/' + totalBatches + ' æ‰¹ï¼ˆæ¯æ‰¹ ' + BATCH_SIZE + ' æ¡ï¼‰...</div>';

                    const response = await fetch(API_URL + '/api/audit_visit/search_time/uploadVisit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ records: batch })
                    });

                    const result = await response.json();
                    if (!result.success) {
                        statusDiv.innerHTML = '<div class="status-message status-error">ç¬¬ ' + (i + 1) + ' æ‰¹ä¸Šä¼ å¤±è´¥: ' + result.error + '</div>';
                        return;
                    }
                    totalInserted += batch.length;
                }

                statusDiv.innerHTML = '<div class="status-message status-success">å…¨éƒ¨ä¸Šä¼ æˆåŠŸï¼å…±å¯¼å…¥ ' + totalInserted + ' æ¡è®°å½•ã€‚</div>';
            } catch (error) {
                statusDiv.innerHTML = '<div class="status-message status-error">ä¸Šä¼ å¤±è´¥: ' + error.message + '<br>è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</div>';
            }
        }

        // ============ Terminal æ–‡ä»¶ä¸Šä¼  ============

        function handleTerminalFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('terminalUploadStatus');
            statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨è¯»å–æ–‡ä»¶...</div>';

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) {
                        statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶ä¸ºç©º</div>';
                        return;
                    }

                    statusDiv.innerHTML = '<div class="status-message status-success">æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå…± ' + jsonData.length + ' æ¡è®°å½•ï¼Œæ­£åœ¨ä¸Šä¼ ...</div>';
                    uploadTerminalInBatches(jsonData);
                } catch (error) {
                    statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶è§£æå¤±è´¥: ' + error.message + '</div>';
                }
            };

            reader.onerror = function() {
                statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶è¯»å–å¤±è´¥</div>';
            };

            reader.readAsArrayBuffer(file);
        }

        async function uploadTerminalInBatches(records) {
            const statusDiv = document.getElementById('terminalUploadStatus');
            const BATCH_SIZE = 5000;
            const totalBatches = Math.ceil(records.length / BATCH_SIZE);
            let totalInserted = 0;

            try {
                for (let i = 0; i < totalBatches; i++) {
                    const batch = records.slice(i * BATCH_SIZE, (i + 1) * BATCH_SIZE);
                    statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨ä¸Šä¼ ç¬¬ ' + (i + 1) + '/' + totalBatches + ' æ‰¹...</div>';

                    const response = await fetch(API_URL + '/api/audit_visit/search_time/uploadTerminal', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ records: batch })
                    });

                    const result = await response.json();
                    if (!result.success) {
                        statusDiv.innerHTML = '<div class="status-message status-error">ç¬¬ ' + (i + 1) + ' æ‰¹ä¸Šä¼ å¤±è´¥: ' + result.error + '</div>';
                        return;
                    }
                    totalInserted += batch.length;
                }

                statusDiv.innerHTML = '<div class="status-message status-success">å…¨éƒ¨ä¸Šä¼ æˆåŠŸï¼å…±å¯¼å…¥ ' + totalInserted + ' æ¡è®°å½•ã€‚</div>';
            } catch (error) {
                statusDiv.innerHTML = '<div class="status-message status-error">ä¸Šä¼ å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // ============ æŸ¥è¯¢ ============

        async function queryRecords() {
            const maxMinutes = parseInt(document.getElementById('maxMinutes').value) || 5;
            const visitor = document.getElementById('visitor').value.trim();
            const customerName = document.getElementById('customerName').value.trim();
            const customerCode = document.getElementById('customerCode').value.trim();
            const area = document.getElementById('area').value.trim();
            const region = document.getElementById('region').value.trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            const params = new URLSearchParams({
                maxMinutes,
                visitor,
                customerName,
                customerCode,
                area,
                region,
                startDate,
                endDate
            });

            const statusDiv = document.getElementById('queryStatus');
            const resultDiv = document.getElementById('resultContainer');
            const paginationDiv = document.getElementById('paginationContainer');
            const regionSummaryDiv = document.getElementById('regionSummaryContainer');

            statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨æŸ¥è¯¢åˆå¹¶æ•°æ®ï¼ˆVisit LEFT JOIN Terminalï¼‰...</div>';
            resultDiv.innerHTML = '';
            paginationDiv.style.display = 'none';
            regionSummaryDiv.innerHTML = '';
            document.getElementById('exportBtn').style.display = 'none';

            // é‡ç½®å±•å¼€çŠ¶æ€
            expandedRegion = null;
            regionAreaMap = {};

            try {
                const response = await fetch(API_URL + '/api/audit_visit/search_time/getMinutes?' + params.toString());
                const result = await response.json();

                if (result.success) {
                    currentData = result.data;
                    currentPage = 1;

                    if (currentData.length === 0) {
                        statusDiv.innerHTML = '<div class="status-message status-info">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®°å½•</div>';
                        resultDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><h3>æš‚æ— ç¬¦åˆæ¡ä»¶çš„è®°å½•</h3><p>è¯·å°è¯•è°ƒæ•´æŸ¥è¯¢æ¡ä»¶</p></div>';
                    } else {
                        totalPages = Math.ceil(currentData.length / pageSize);
                        statusDiv.innerHTML = '<div class="status-message status-success">æŸ¥è¯¢æˆåŠŸï¼æ‰¾åˆ° ' + currentData.length + ' æ¡è®°å½•ï¼Œå…± ' + totalPages + ' é¡µ</div>';
                        buildRegionAreaMap();
                        renderRegionSummary();
                        displayResults();
                        renderPagination();
                        document.getElementById('exportBtn').style.display = 'inline-flex';
                        paginationDiv.style.display = 'block';
                    }
                } else {
                    statusDiv.innerHTML = '<div class="status-message status-error">æŸ¥è¯¢å¤±è´¥: ' + result.error + '</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status-message status-error">æŸ¥è¯¢å¤±è´¥: ' + error.message + '<br>è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</div>';
            }
        }

        // ============ æ¸…ç†æ•°æ®åº“ ============
        async function cleanupDatabase() {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤å½“å‰æ•°æ®åº“åŠå…¶ä¸­çš„æ‰€æœ‰æ•°æ®ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                return;
            }


            const statusDiv = document.getElementById('cleanupStatus');
            statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨åˆ é™¤æ•°æ®åº“...</div>';

            try {
                const response = await fetch(API_URL + '/api/audit_visit/search_time/cleanup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    statusDiv.innerHTML = '<div class="status-message status-success">âœ… æ•°æ®åº“å·²æˆåŠŸåˆ é™¤ï¼æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºã€‚æ‚¨å¯ä»¥é‡æ–°ä¸Šä¼ æ•°æ®ã€‚</div>';
                    
                    // æ¸…ç©ºé¡µé¢æ•°æ®
                    currentData = [];
                    document.getElementById('uploadStatus').innerHTML = '';
                    document.getElementById('terminalUploadStatus').innerHTML = '';
                    document.getElementById('queryStatus').innerHTML = '';
                    document.getElementById('resultContainer').innerHTML = '';
                    document.getElementById('regionSummaryContainer').innerHTML = '';
                    document.getElementById('paginationContainer').style.display = 'none';
                    document.getElementById('exportBtn').style.display = 'none';
                    
                    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    document.getElementById('fileInput').value = '';
                    document.getElementById('terminalFileInput').value = '';
                } else {
                    statusDiv.innerHTML = '<div class="status-message status-error">åˆ é™¤å¤±è´¥: ' + result.error + '</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status-message status-error">åˆ é™¤å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // ============ æ„å»ºå¤§åŒº->ç‰‡åŒºæ˜ å°„ ============

        function buildRegionAreaMap() {
            regionAreaMap = {};

            currentData.forEach(function(row) {
                var regionName = row.æ‰€å±å¤§åŒº || 'æœªçŸ¥å¤§åŒº';
                var areaName = row.æ‰€å±ç‰‡åŒº || 'æœªçŸ¥ç‰‡åŒº';

                if (!regionAreaMap[regionName]) {
                    regionAreaMap[regionName] = {};
                }
                if (!regionAreaMap[regionName][areaName]) {
                    regionAreaMap[regionName][areaName] = 0;
                }
                regionAreaMap[regionName][areaName]++;
            });
        }

        // ============ å¤§åŒºå¼‚å¸¸ç»Ÿè®¡ ============

        function renderRegionSummary() {
            var regionSummaryDiv = document.getElementById('regionSummaryContainer');

            // ç»Ÿè®¡æ¯ä¸ªå¤§åŒºçš„å¼‚å¸¸è®°å½•æ•°
            var regionCountMap = {};
            var totalCount = currentData.length;

            currentData.forEach(function(row) {
                var regionName = row.æ‰€å±å¤§åŒº || 'æœªçŸ¥å¤§åŒº';
                if (!regionCountMap[regionName]) {
                    regionCountMap[regionName] = 0;
                }
                regionCountMap[regionName]++;
            });

            // å°†ç»Ÿè®¡ç»“æœè½¬ä¸ºæ•°ç»„å¹¶æŒ‰æ•°é‡é™åºæ’åˆ—
            var regionList = [];
            for (var key in regionCountMap) {
                if (regionCountMap.hasOwnProperty(key)) {
                    regionList.push({ name: key, count: regionCountMap[key] });
                }
            }
            regionList.sort(function(a, b) { return b.count - a.count; });

            // æ„å»º HTML
            var html = '<div class="region-summary">';
            html += '<div class="region-summary-title">å„å¤§åŒºå¼‚å¸¸æƒ…å†µç»Ÿè®¡</div>';
            html += '<div class="region-summary-desc">';
            html += 'ä»¥ä¸‹ç»Ÿè®¡åŸºäºå½“å‰æŸ¥è¯¢æ¡ä»¶ç­›é€‰å‡ºçš„ç»“æœï¼Œå±•ç¤ºæ¯ä¸ªå¤§åŒºåœ¨è¯¥æŸ¥è¯¢æ¡ä»¶ä¸‹çš„å¼‚å¸¸æ‹œè®¿è®°å½•æ•°é‡ã€‚';
            html += 'å¼‚å¸¸æ ‡å‡†ï¼šæ‹œè®¿ç”¨æ—¶ &le; ' + (parseInt(document.getElementById('maxMinutes').value) || 5) + ' åˆ†é’Ÿçš„è®°å½•ã€‚';
            html += '<br><strong>ç‚¹å‡»å¤§åŒºå¡ç‰‡å¯æŸ¥çœ‹è¯¥å¤§åŒºä¸‹å„ç‰‡åŒºçš„å¼‚å¸¸æƒ…å†µæ˜ç»†ã€‚</strong>';
            html += '</div>';

            // å¡ç‰‡å±•ç¤º
            html += '<div class="region-cards">';
            regionList.forEach(function(item) {
                var isUnknown = (item.name === 'æœªçŸ¥å¤§åŒº');
                var isActive = (expandedRegion === item.name);
                var escapedName = item.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                html += '<div class="region-card' + (isUnknown ? ' unknown' : '') + (isActive ? ' active' : '') + '" onclick="toggleRegionDetail(\'' + escapedName + '\')" title="ç‚¹å‡»æŸ¥çœ‹ç‰‡åŒºæ˜ç»†">';
                html += '<div class="region-card-name">' + item.name + '</div>';
                html += '<div class="region-card-count">' + item.count + '</div>';
                html += '<div class="region-card-unit">æ¡å¼‚å¸¸è®°å½•</div>';
                html += '<div class="region-card-hint">' + (isActive ? '&#9650; ç‚¹å‡»æ”¶èµ·ç‰‡åŒºæ˜ç»†' : '&#9660; ç‚¹å‡»å±•å¼€ç‰‡åŒºæ˜ç»†') + '</div>';
                html += '</div>';
            });
            html += '</div>';

            // ç‰‡åŒºå±•å¼€é¢æ¿ï¼ˆæ”¾åœ¨å¡ç‰‡ä¸‹æ–¹ï¼‰
            html += '<div class="area-detail-panel' + (expandedRegion ? ' open' : '') + '" id="areaDetailPanel">';
            html += '<div id="areaDetailContent"></div>';
            html += '</div>';

            // æ±‡æ€»æ¡
            html += '<div class="region-total-bar">';
            html += '<strong>å¼‚å¸¸è®°å½•æ€»è®¡ï¼š</strong>';
            html += '<span>' + totalCount + '</span>';
            html += '<strong style="margin-left: 5px;">æ¡</strong>';
            html += '<span style="color: #6b7280; font-size: 14px; font-weight: normal; margin-left: 15px;">ï¼ˆè¦†ç›– ' + regionList.length + ' ä¸ªå¤§åŒºï¼‰</span>';
            html += '</div>';

            // æ˜ç»†è¡¨æ ¼
            html += '<div class="table-container" style="margin-top: 15px;">';
            html += '<table class="region-summary-table">';
            html += '<thead><tr>';
            html += '<th>åºå·</th>';
            html += '<th>æ‰€å±å¤§åŒº</th>';
            html += '<th>å¼‚å¸¸è®°å½•æ•°</th>';
            html += '<th>å æ¯”</th>';
            html += '</tr></thead>';
            html += '<tbody>';

            regionList.forEach(function(item, index) {
                var percent = totalCount > 0 ? ((item.count / totalCount) * 100).toFixed(2) : '0.00';
                html += '<tr>';
                html += '<td>' + (index + 1) + '</td>';
                html += '<td>' + item.name + '</td>';
                html += '<td class="count-cell">' + item.count + '</td>';
                html += '<td class="percent-cell">' + percent + '%</td>';
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            html += '</div>';

            regionSummaryDiv.innerHTML = html;

            // å¦‚æœæœ‰å±•å¼€çš„å¤§åŒºï¼Œæ¸²æŸ“å…¶ç‰‡åŒºå†…å®¹
            if (expandedRegion) {
                renderAreaDetail(expandedRegion);
            }
        }

        // ============ åˆ‡æ¢å¤§åŒºç‰‡åŒºå±•å¼€ ============

        function toggleRegionDetail(regionName) {
            if (expandedRegion === regionName) {
                // å†æ¬¡ç‚¹å‡»åŒä¸€å¤§åŒºï¼Œæ”¶èµ·
                expandedRegion = null;
                var panel = document.getElementById('areaDetailPanel');
                if (panel) {
                    panel.classList.remove('open');
                }
                // æ›´æ–°å¡ç‰‡çš„ active çŠ¶æ€å’Œç®­å¤´
                updateCardStates();
            } else {
                // ç‚¹å‡»ä¸åŒå¤§åŒºï¼Œå±•å¼€ï¼ˆæˆ–åˆ‡æ¢ï¼‰
                expandedRegion = regionName;
                renderAreaDetail(regionName);
                var panel = document.getElementById('areaDetailPanel');
                if (panel) {
                    panel.classList.add('open');
                }
                // æ›´æ–°å¡ç‰‡çš„ active çŠ¶æ€å’Œç®­å¤´
                updateCardStates();
                // æ»šåŠ¨åˆ°é¢æ¿ä½ç½®
                setTimeout(function() {
                    var panelEl = document.getElementById('areaDetailPanel');
                    if (panelEl) {
                        panelEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }, 100);
            }
        }

        // æ›´æ–°æ‰€æœ‰å¤§åŒºå¡ç‰‡çš„ active çŠ¶æ€å’Œç®­å¤´æç¤ºæ–‡å­—
        function updateCardStates() {
            var cards = document.querySelectorAll('.region-card');
            cards.forEach(function(card) {
                var nameEl = card.querySelector('.region-card-name');
                var hintEl = card.querySelector('.region-card-hint');
                if (!nameEl || !hintEl) return;

                var cardName = nameEl.textContent;
                if (cardName === expandedRegion) {
                    card.classList.add('active');
                    hintEl.innerHTML = '&#9650; ç‚¹å‡»æ”¶èµ·ç‰‡åŒºæ˜ç»†';
                } else {
                    card.classList.remove('active');
                    hintEl.innerHTML = '&#9660; ç‚¹å‡»å±•å¼€ç‰‡åŒºæ˜ç»†';
                }
            });
        }

        // ============ æ¸²æŸ“ç‰‡åŒºæ˜ç»† ============

        function renderAreaDetail(regionName) {
            var contentDiv = document.getElementById('areaDetailContent');
            if (!contentDiv) return;

            var areaMap = regionAreaMap[regionName];
            if (!areaMap) {
                contentDiv.innerHTML = '<p style="color: #6b7280;">è¯¥å¤§åŒºä¸‹æ— ç‰‡åŒºæ•°æ®ã€‚</p>';
                return;
            }

            // æ„å»ºç‰‡åŒºåˆ—è¡¨å¹¶æ’åº
            var areaList = [];
            var regionTotal = 0;
            for (var key in areaMap) {
                if (areaMap.hasOwnProperty(key)) {
                    areaList.push({ name: key, count: areaMap[key] });
                    regionTotal += areaMap[key];
                }
            }
            areaList.sort(function(a, b) { return b.count - a.count; });

            var html = '';

            // å¤´éƒ¨
            html += '<div class="area-detail-header">';
            html += '<div class="area-detail-title"><span>' + regionName + '</span> - å„ç‰‡åŒºå¼‚å¸¸æƒ…å†µæ˜ç»†ï¼ˆå…± ' + areaList.length + ' ä¸ªç‰‡åŒºï¼‰</div>';
            html += '<button class="area-detail-close" onclick="toggleRegionDetail(\'' + regionName.replace(/'/g, "\\'") + '\')" title="æ”¶èµ·">&times;</button>';
            html += '</div>';

            // ç‰‡åŒºå¡ç‰‡
            html += '<div class="area-cards">';
            areaList.forEach(function(item) {
                var percent = regionTotal > 0 ? ((item.count / regionTotal) * 100).toFixed(1) : '0.0';
                html += '<div class="area-card">';
                html += '<div class="area-card-name">' + item.name + '</div>';
                html += '<div class="area-card-count">' + item.count + '</div>';
                html += '<div class="area-card-unit">æ¡å¼‚å¸¸è®°å½•</div>';
                html += '<div class="area-card-percent">å æœ¬å¤§åŒº ' + percent + '%</div>';
                html += '</div>';
            });
            html += '</div>';

            // ç‰‡åŒºæ˜ç»†è¡¨æ ¼
            html += '<div class="area-detail-table-wrap">';
            html += '<table class="area-detail-table">';
            html += '<thead><tr>';
            html += '<th>åºå·</th>';
            html += '<th>æ‰€å±ç‰‡åŒº</th>';
            html += '<th>å¼‚å¸¸è®°å½•æ•°</th>';
            html += '<th>å æœ¬å¤§åŒºæ¯”ä¾‹</th>';
            html += '</tr></thead>';
            html += '<tbody>';

            areaList.forEach(function(item, index) {
                var percent = regionTotal > 0 ? ((item.count / regionTotal) * 100).toFixed(2) : '0.00';
                html += '<tr>';
                html += '<td>' + (index + 1) + '</td>';
                html += '<td>' + item.name + '</td>';
                html += '<td class="area-count-cell">' + item.count + '</td>';
                html += '<td class="area-percent-cell">' + percent + '%</td>';
                html += '</tr>';
            });

            html += '</tbody></table></div>';

            // æ±‡æ€»
            html += '<div class="area-detail-total">';
            html += '<strong>' + regionName + ' å¼‚å¸¸åˆè®¡ï¼š</strong>';
            html += '<span>' + regionTotal + '</span>';
            html += '<strong style="margin-left: 3px;">æ¡</strong>';
            html += '<span style="color: #6b7280; font-size: 13px; font-weight: normal; margin-left: 10px;">ï¼ˆå« ' + areaList.length + ' ä¸ªç‰‡åŒºï¼‰</span>';
            html += '</div>';

            contentDiv.innerHTML = html;
        }

        // ============ æ˜¾ç¤ºç»“æœï¼ˆåˆ†é¡µï¼‰ ============

        function displayResults() {
            const resultDiv = document.getElementById('resultContainer');

            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, currentData.length);
            const pageData = currentData.slice(startIndex, endIndex);

            let tableHTML = '<div class="table-container"><table><thead><tr>';
            tableHTML += '<th>åºå·</th>';
            tableHTML += '<th>æ‹œè®¿è®°å½•ç¼–å·</th>';
            tableHTML += '<th>æ‹œè®¿å¼€å§‹æ—¶é—´</th>';
            tableHTML += '<th>æ‹œè®¿ç»“æŸæ—¶é—´</th>';
            tableHTML += '<th>æ‹œè®¿äºº</th>';
            tableHTML += '<th>å®¢æˆ·åç§°</th>';
            tableHTML += '<th>å®¢æˆ·ç¼–ç </th>';
            tableHTML += '<th>æ‹œè®¿ç”¨æ—¶</th>';
            tableHTML += '<th>æ‰€å±ç‰‡åŒº</th>';
            tableHTML += '<th>æ‰€å±å¤§åŒº</th>';
            tableHTML += '</tr></thead><tbody>';

            pageData.forEach(function(row, index) {
                var globalIndex = startIndex + index + 1;
                tableHTML += '<tr>';
                tableHTML += '<td><strong>' + globalIndex + '</strong></td>';
                tableHTML += '<td>' + (row.æ‹œè®¿è®°å½•ç¼–å· || '-') + '</td>';
                tableHTML += '<td>' + (row.æ‹œè®¿å¼€å§‹æ—¶é—´ || '-') + '</td>';
                tableHTML += '<td>' + (row.æ‹œè®¿ç»“æŸæ—¶é—´ || '-') + '</td>';
                tableHTML += '<td>' + (row.æ‹œè®¿äºº || '-') + '</td>';
                tableHTML += '<td>' + (row.å®¢æˆ·åç§° || '-') + '</td>';
                tableHTML += '<td>' + (row.å®¢æˆ·ç¼–ç  || '-') + '</td>';
                tableHTML += '<td><span class="badge">' + row.æ‹œè®¿ç”¨æ—¶ + ' åˆ†é’Ÿ</span></td>';
                tableHTML += '<td>' + (row.æ‰€å±ç‰‡åŒº || '-') + '</td>';
                tableHTML += '<td>' + (row.æ‰€å±å¤§åŒº || '-') + '</td>';
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table></div>';
            resultDiv.innerHTML = tableHTML;
        }

        // ============ åˆ†é¡µ ============

        function renderPagination() {
            const paginationDiv = document.getElementById('paginationContainer');

            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, currentData.length);

            let html = '<div class="pagination-container">';
            html += '<div class="pagination-info">';
            html += 'æ˜¾ç¤º <strong>' + startIndex + '</strong> - <strong>' + endIndex + '</strong> æ¡ï¼Œ';
            html += 'å…± <strong>' + currentData.length + '</strong> æ¡è®°å½•';
            html += '</div>';

            html += '<div class="pagination-controls">';

            html += '<div class="page-size-selector">';
            html += '<label>æ¯é¡µæ˜¾ç¤ºï¼š</label>';
            html += '<select onchange="changePageSize(this.value)">';
            [100, 500, 1000, 2000].forEach(function(size) {
                html += '<option value="' + size + '"' + (pageSize === size ? ' selected' : '') + '>' + size + '</option>';
            });
            html += '</select></div>';

            html += '<button class="page-btn" onclick="goToPage(1)"' + (currentPage === 1 ? ' disabled' : '') + '>é¦–é¡µ</button>';
            html += '<button class="page-btn" onclick="goToPage(' + (currentPage - 1) + ')"' + (currentPage === 1 ? ' disabled' : '') + '>ä¸Šä¸€é¡µ</button>';

            html += '<div class="page-numbers">' + generatePageNumbers() + '</div>';

            html += '<button class="page-btn" onclick="goToPage(' + (currentPage + 1) + ')"' + (currentPage === totalPages ? ' disabled' : '') + '>ä¸‹ä¸€é¡µ</button>';
            html += '<button class="page-btn" onclick="goToPage(' + totalPages + ')"' + (currentPage === totalPages ? ' disabled' : '') + '>æœ«é¡µ</button>';

            html += '</div></div>';

            paginationDiv.innerHTML = html;
        }

        function generatePageNumbers() {
            let html = '';
            const maxVisible = 7;

            if (totalPages <= maxVisible) {
                for (let i = 1; i <= totalPages; i++) {
                    html += '<div class="page-number' + (i === currentPage ? ' active' : '') + '" onclick="goToPage(' + i + ')">' + i + '</div>';
                }
            } else {
                if (currentPage <= 4) {
                    for (let i = 1; i <= 5; i++) {
                        html += '<div class="page-number' + (i === currentPage ? ' active' : '') + '" onclick="goToPage(' + i + ')">' + i + '</div>';
                    }
                    html += '<div class="page-ellipsis">...</div>';
                    html += '<div class="page-number" onclick="goToPage(' + totalPages + ')">' + totalPages + '</div>';
                } else if (currentPage >= totalPages - 3) {
                    html += '<div class="page-number" onclick="goToPage(1)">1</div>';
                    html += '<div class="page-ellipsis">...</div>';
                    for (let i = totalPages - 4; i <= totalPages; i++) {
                        html += '<div class="page-number' + (i === currentPage ? ' active' : '') + '" onclick="goToPage(' + i + ')">' + i + '</div>';
                    }
                } else {
                    html += '<div class="page-number" onclick="goToPage(1)">1</div>';
                    html += '<div class="page-ellipsis">...</div>';
                    for (let i = currentPage - 1; i <= currentPage + 1; i++) {
                        html += '<div class="page-number' + (i === currentPage ? ' active' : '') + '" onclick="goToPage(' + i + ')">' + i + '</div>';
                    }
                    html += '<div class="page-ellipsis">...</div>';
                    html += '<div class="page-number" onclick="goToPage(' + totalPages + ')">' + totalPages + '</div>';
                }
            }

            return html;
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            currentPage = page;
            displayResults();
            renderPagination();
            document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function changePageSize(newSize) {
            pageSize = parseInt(newSize);
            totalPages = Math.ceil(currentData.length / pageSize);
            currentPage = 1;
            displayResults();
            renderPagination();
        }

        // ============ å¯¼å‡º Excel ============

        function exportToExcel() {
            if (currentData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡º');
                return;
            }

            var exportData = currentData.map(function(row, index) {
                return {
                    'åºå·': index + 1,
                    'æ‹œè®¿è®°å½•ç¼–å·': row.æ‹œè®¿è®°å½•ç¼–å· || '-',
                    'æ‹œè®¿å¼€å§‹æ—¶é—´': row.æ‹œè®¿å¼€å§‹æ—¶é—´ || '-',
                    'æ‹œè®¿ç»“æŸæ—¶é—´': row.æ‹œè®¿ç»“æŸæ—¶é—´ || '-',
                    'æ‹œè®¿äºº': row.æ‹œè®¿äºº || '-',
                    'å®¢æˆ·åç§°': row.å®¢æˆ·åç§° || '-',
                    'å®¢æˆ·ç¼–ç ': row.å®¢æˆ·ç¼–ç  || '-',
                    'æ‹œè®¿ç”¨æ—¶ï¼ˆåˆ†é’Ÿï¼‰': row.æ‹œè®¿ç”¨æ—¶,
                    'æ‰€å±ç‰‡åŒº': row.æ‰€å±ç‰‡åŒº || '-',
                    'æ‰€å±å¤§åŒº': row.æ‰€å±å¤§åŒº || '-'
                };
            });

            // æ„å»ºå¤§åŒºç»Ÿè®¡æ•°æ®
            var regionCountMap = {};
            currentData.forEach(function(row) {
                var regionName = row.æ‰€å±å¤§åŒº || 'æœªçŸ¥å¤§åŒº';
                if (!regionCountMap[regionName]) {
                    regionCountMap[regionName] = 0;
                }
                regionCountMap[regionName]++;
            });
            var regionList = [];
            for (var key in regionCountMap) {
                if (regionCountMap.hasOwnProperty(key)) {
                    regionList.push({ name: key, count: regionCountMap[key] });
                }
            }
            regionList.sort(function(a, b) { return b.count - a.count; });

            var regionExportData = regionList.map(function(item, index) {
                var percent = currentData.length > 0 ? ((item.count / currentData.length) * 100).toFixed(2) + '%' : '0.00%';
                return {
                    'åºå·': index + 1,
                    'æ‰€å±å¤§åŒº': item.name,
                    'å¼‚å¸¸è®°å½•æ•°': item.count,
                    'å æ¯”': percent
                };
            });
            regionExportData.push({
                'åºå·': '',
                'æ‰€å±å¤§åŒº': 'åˆè®¡',
                'å¼‚å¸¸è®°å½•æ•°': currentData.length,
                'å æ¯”': '100.00%'
            });

            // æ„å»ºå¤§åŒº->ç‰‡åŒºæ˜ç»†ç»Ÿè®¡æ•°æ®
            var areaDetailExportData = [];
            var seq = 1;
            regionList.forEach(function(regionItem) {
                var areaMap = regionAreaMap[regionItem.name];
                if (!areaMap) return;

                var areaList = [];
                for (var aKey in areaMap) {
                    if (areaMap.hasOwnProperty(aKey)) {
                        areaList.push({ name: aKey, count: areaMap[aKey] });
                    }
                }
                areaList.sort(function(a, b) { return b.count - a.count; });

                areaList.forEach(function(areaItem) {
                    var percentInRegion = regionItem.count > 0 ? ((areaItem.count / regionItem.count) * 100).toFixed(2) + '%' : '0.00%';
                    var percentInTotal = currentData.length > 0 ? ((areaItem.count / currentData.length) * 100).toFixed(2) + '%' : '0.00%';
                    areaDetailExportData.push({
                        'åºå·': seq++,
                        'æ‰€å±å¤§åŒº': regionItem.name,
                        'æ‰€å±ç‰‡åŒº': areaItem.name,
                        'å¼‚å¸¸è®°å½•æ•°': areaItem.count,
                        'å æœ¬å¤§åŒºæ¯”ä¾‹': percentInRegion,
                        'å æ€»ä½“æ¯”ä¾‹': percentInTotal
                    });
                });
            });

            var wb = XLSX.utils.book_new();

            // Sheet 1: æŸ¥è¯¢æ˜ç»†
            var ws = XLSX.utils.json_to_sheet(exportData);
            ws['!cols'] = [
                { wch: 8 },
                { wch: 20 },
                { wch: 20 },
                { wch: 20 },
                { wch: 15 },
                { wch: 25 },
                { wch: 20 },
                { wch: 15 },
                { wch: 15 },
                { wch: 15 }
            ];
            XLSX.utils.book_append_sheet(wb, ws, 'åˆå¹¶æŸ¥è¯¢ç»“æœ');

            // Sheet 2: å¤§åŒºç»Ÿè®¡
            var ws2 = XLSX.utils.json_to_sheet(regionExportData);
            ws2['!cols'] = [
                { wch: 8 },
                { wch: 20 },
                { wch: 15 },
                { wch: 10 }
            ];
            XLSX.utils.book_append_sheet(wb, ws2, 'å¤§åŒºå¼‚å¸¸ç»Ÿè®¡');

            // Sheet 3: å¤§åŒº-ç‰‡åŒºæ˜ç»†ç»Ÿè®¡
            var ws3 = XLSX.utils.json_to_sheet(areaDetailExportData);
            ws3['!cols'] = [
                { wch: 8 },
                { wch: 20 },
                { wch: 20 },
                { wch: 15 },
                { wch: 15 },
                { wch: 12 }
            ];
            XLSX.utils.book_append_sheet(wb, ws3, 'å¤§åŒº-ç‰‡åŒºæ˜ç»†ç»Ÿè®¡');

            var date = new Date().toISOString().split('T')[0];
            var filename = 'Visit_Terminal_åˆå¹¶æŸ¥è¯¢_' + date + '.xlsx';
            XLSX.writeFile(wb, filename);

            alert('å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶åï¼š' + filename + 'ï¼Œå…±å¯¼å‡º ' + currentData.length + ' æ¡è®°å½•ï¼ˆå«å¤§åŒºç»Ÿè®¡ã€å¤§åŒº-ç‰‡åŒºæ˜ç»†ç»Ÿè®¡Sheetï¼‰');
        }

        // ============ æ‹–æ‹½ä¸Šä¼ æ”¯æŒ ============

        function setupDragDrop(areaId, fileInputId, handler) {
            var area = document.getElementById(areaId);

            area.addEventListener('dragover', function(e) {
                e.preventDefault();
                area.classList.add('dragover');
            });

            area.addEventListener('dragleave', function(e) {
                e.preventDefault();
                area.classList.remove('dragover');
            });

            area.addEventListener('drop', function(e) {
                e.preventDefault();
                area.classList.remove('dragover');
                var files = e.dataTransfer.files;
                if (files.length > 0) {
                    var fileInput = document.getElementById(fileInputId);
                    fileInput.files = files;
                    handler({ target: fileInput });
                }
            });
        }

        setupDragDrop('visitUploadArea', 'fileInput', handleFileSelect);
        setupDragDrop('terminalUploadArea', 'terminalFileInput', handleTerminalFileSelect);
    </script>
</body>
</html>